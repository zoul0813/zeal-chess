#include <stdio.h>
#include <ctype.h>
#include <stdlib.h>
#include <string.h>
#include <zvb_gfx.h>
#include <zos_sys.h>

#include "chess.h"

#define GFX_WIDTH           20
#define GFX_HEIGHT          15
#define TILE_SIZE           16

#define TILE_PER_SPRITE     4
#define TILE_PIECES_START   16
#define PIECES_PALETTE      1

static gfx_context s_gfx;
static uint8_t     s_sprite_idx;

/* 4 16-bit colors for the board palette */
static const uint8_t s_board_palette[] = {
    /* 4 colors for the board */
    0x28, 0x42, 0x84, 0x49, 0xe8, 0x7a, 0x32, 0xde,
    /* 12 dummy colors */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    /* 5 colors for the pieces + transparency */
    0x00, 0x00, 0xe7, 0x31, 0x6f, 0x52, 0x7c, 0x5b, 0x5e, 0x5d, 0xfe, 0x5e
};

static const uint8_t s_board_tilemap[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x03, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x05, 0x06, 0x05, 0x06, 0x03, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x03, 0x04, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x02, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x03, 0x04, 0x00, 0x00,
    0x00, 0x00, 0x07, 0x08, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x09, 0x0a, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x07, 0x08, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x09, 0x0a, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x08, 0x05, 0x06, 0x05, 0x06, 0x09, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x08, 0x09, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

static const uint8_t s_board_tileset[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x5f, 0x00, 0x00, 0x05, 0xff,
    0x00, 0x00, 0x5f, 0xff, 0x00, 0x05, 0xff, 0xff, 0x00, 0x5f, 0xff, 0xff,
    0x05, 0xff, 0xff, 0xff, 0x5f, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x05,
    0x00, 0x00, 0x00, 0x5a, 0x00, 0x00, 0x05, 0xaa, 0x00, 0x00, 0x5a, 0xaa,
    0x00, 0x05, 0xaa, 0xaa, 0x00, 0x5a, 0xaa, 0xaa, 0x05, 0xaa, 0xaa, 0xaa,
    0x5a, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0x5a, 0xaa, 0xaa, 0xaa,
    0xf5, 0xaa, 0xaa, 0xaa, 0xff, 0x5a, 0xaa, 0xaa, 0xff, 0xf5, 0xaa, 0xaa,
    0xff, 0xff, 0x5a, 0xaa, 0xff, 0xff, 0xf5, 0xaa, 0xff, 0xff, 0xff, 0x5a,
    0x50, 0x00, 0x00, 0x00, 0xa5, 0x00, 0x00, 0x00, 0xaa, 0x50, 0x00, 0x00,
    0xaa, 0xa5, 0x00, 0x00, 0xaa, 0xaa, 0x50, 0x00, 0xaa, 0xaa, 0xa5, 0x00,
    0xaa, 0xaa, 0xaa, 0x50, 0xaa, 0xaa, 0xaa, 0xa5, 0xaa, 0xaa, 0xaa, 0xa9,
    0xaa, 0xaa, 0xaa, 0x97, 0xaa, 0xaa, 0xa9, 0x7f, 0xaa, 0xaa, 0x97, 0xff,
    0xaa, 0xa9, 0x7f, 0xff, 0xaa, 0x97, 0xff, 0xff, 0xa9, 0x7f, 0xff, 0xff,
    0x97, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x50, 0x00, 0x00, 0x00, 0xf5, 0x00, 0x00, 0x00, 0xff, 0x50, 0x00, 0x00,
    0xff, 0xf5, 0x00, 0x00, 0xff, 0xff, 0x50, 0x00, 0xff, 0xff, 0xf5, 0x00,
    0xff, 0xff, 0xff, 0x50, 0xff, 0xff, 0xff, 0xf5, 0x5f, 0xff, 0xff, 0xff,
    0x97, 0xff, 0xff, 0xff, 0xa9, 0x7f, 0xff, 0xff, 0xaa, 0x97, 0xff, 0xff,
    0xaa, 0xa9, 0x7f, 0xff, 0xaa, 0xaa, 0x97, 0xff, 0xaa, 0xaa, 0xa9, 0x7f,
    0xaa, 0xaa, 0xaa, 0x97, 0xaa, 0xaa, 0xaa, 0xa9, 0xaa, 0xaa, 0xaa, 0xa5,
    0xaa, 0xaa, 0xaa, 0x5f, 0xaa, 0xaa, 0xa5, 0xff, 0xaa, 0xaa, 0x5f, 0xff,
    0xaa, 0xa5, 0xff, 0xff, 0xaa, 0x5f, 0xff, 0xff, 0xa5, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf5, 0xff, 0xff, 0xff, 0x5a,
    0xff, 0xff, 0xf5, 0xaa, 0xff, 0xff, 0x5a, 0xaa, 0xff, 0xf5, 0xaa, 0xaa,
    0xff, 0x5a, 0xaa, 0xaa, 0xf5, 0xaa, 0xaa, 0xaa, 0x5a, 0xaa, 0xaa, 0xaa,
    0xf5, 0xaa, 0xaa, 0xaa, 0xff, 0x5a, 0xaa, 0xaa, 0xff, 0xf5, 0xaa, 0xaa,
    0xff, 0xff, 0x5a, 0xaa, 0xff, 0xff, 0xf5, 0xaa, 0xff, 0xff, 0xff, 0x5a,
    0xff, 0xff, 0xff, 0xf5, 0x5f, 0xff, 0xff, 0xff, 0x05, 0xff, 0xff, 0xff,
    0x00, 0x5f, 0xff, 0xff, 0x00, 0x05, 0xff, 0xff, 0x00, 0x00, 0x5f, 0xff,
    0x00, 0x00, 0x05, 0xff, 0x00, 0x00, 0x00, 0x5f, 0x00, 0x00, 0x00, 0x05,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xf5,
    0xff, 0xff, 0xff, 0xd6, 0xff, 0xff, 0xfd, 0x6a, 0xff, 0xff, 0xd6, 0xaa,
    0xff, 0xfd, 0x6a, 0xaa, 0xff, 0xd6, 0xaa, 0xaa, 0xfd, 0x6a, 0xaa, 0xaa,
    0xd6, 0xaa, 0xaa, 0xaa, 0x5a, 0xaa, 0xaa, 0xaa, 0x05, 0xaa, 0xaa, 0xaa,
    0x00, 0x5a, 0xaa, 0xaa, 0x00, 0x05, 0xaa, 0xaa, 0x00, 0x00, 0x5a, 0xaa,
    0x00, 0x00, 0x05, 0xaa, 0x00, 0x00, 0x00, 0x5a, 0x00, 0x00, 0x00, 0x05,
    0xff, 0xff, 0xff, 0xff, 0x5f, 0xff, 0xff, 0xff, 0xa5, 0xff, 0xff, 0xff,
    0xaa, 0x5f, 0xff, 0xff, 0xaa, 0xa5, 0xff, 0xff, 0xaa, 0xaa, 0x5f, 0xff,
    0xaa, 0xaa, 0xa5, 0xff, 0xaa, 0xaa, 0xaa, 0x5f, 0xaa, 0xaa, 0xaa, 0xa5,
    0xaa, 0xaa, 0xaa, 0x50, 0xaa, 0xaa, 0xa5, 0x00, 0xaa, 0xaa, 0x50, 0x00,
    0xaa, 0xa5, 0x00, 0x00, 0xaa, 0x50, 0x00, 0x00, 0xa5, 0x00, 0x00, 0x00,
    0x50, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xf5, 0xff, 0xff, 0xff, 0x50,
    0xff, 0xff, 0xf5, 0x00, 0xff, 0xff, 0x50, 0x00, 0xff, 0xf5, 0x00, 0x00,
    0xff, 0x50, 0x00, 0x00, 0xf5, 0x00, 0x00, 0x00, 0x50, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

extern uint8_t _pieces_tileset_start;
extern uint8_t _pieces_tileset_end;
static void _pieces_tileset(void) {
    __asm
__pieces_tileset_start:
    .incbin "assets/pieces_blue.zts"
__pieces_tileset_end:
    __endasm;
}


void view_init(void)
{
    uint8_t empty[GFX_WIDTH];

    if (gfx_initialize(ZVB_CTRL_VID_MODE_GFX_320_4BIT, &s_gfx)) {
        exit(1);
    }

    gfx_enable_screen(0);

    /* Load the palette */
    if (gfx_palette_load(&s_gfx, s_board_palette, sizeof(s_board_palette), 0)) {
        exit(1);
    }

    /* The tileset is "compressed" in 2-bit mode, so 2 bits represent a pixel */
    gfx_tileset_options options = {
        .compression = TILESET_COMP_2BIT,
    };
    if (gfx_tileset_load(&s_gfx, s_board_tileset, sizeof(s_board_tileset), &options)) {
        exit(1);
    }

    /* Load the pieces tileset */
    options.compression = TILESET_COMP_NONE;
    options.from_byte = TILE_PIECES_START << 7; // Start at tile 16 (16 * 128);
    const int pieces_tileset_size = &_pieces_tileset_end - &_pieces_tileset_start;
    if (gfx_tileset_load(&s_gfx, &_pieces_tileset_start, pieces_tileset_size, &options)) {
        exit(1);
    }

    /* Load the tilemap (layer0) */
    const uint8_t *tilemap = s_board_tilemap;
    memset(empty, 0, sizeof(empty));
    for (uint8_t i = 0; i < GFX_HEIGHT; i++) {
        gfx_tilemap_load(&s_gfx, tilemap, GFX_WIDTH, 0, 0, i);
        gfx_tilemap_load(&s_gfx, empty,   GFX_WIDTH, 1, 0, i);
        tilemap += GFX_WIDTH;
    }

    gfx_enable_screen(1);
}


void view_clear_pieces(void)
{
    for (uint8_t i = 0; i < GFX_SPRITES_COUNT; i++) {
        gfx_sprite_set_x(&s_gfx, i, 0);
    }
    s_sprite_idx = 0;
}


void view_place_piece(uint8_t x, uint8_t y, uint8_t type, uint8_t color)
{
    if (type == EMPTY) {
        return;
    }

    const uint8_t y_flipped = 7 - y;
    /* Sprites positions start at 16 */
    // const uint16_t iso_x = ((uint16_t) (x - y_flipped) * (TILE_SIZE / 2)) + 16 + 87;
    /* Teh board has an offset on screen, so -62 */
    // const uint16_t iso_y = ((uint16_t) (x + y_flipped) * (TILE_SIZE / 2)) + 16 - 12;
    const uint16_t iso_x = 160 + (y - x) * 16;
    const uint16_t iso_y = 172 - (y + x) * 8;

    const uint8_t start_tile = TILE_PIECES_START + ((type - 1) * TILE_PER_SPRITE);

    /* Top left part of the piece */
    gfx_sprite_set_x(&s_gfx, s_sprite_idx, iso_x);
    gfx_sprite_set_y(&s_gfx, s_sprite_idx, iso_y);
    gfx_sprite_set_tile(&s_gfx, s_sprite_idx, start_tile);
    gfx_sprite_set_flags(&s_gfx, s_sprite_idx, PIECES_PALETTE << 4);
    s_sprite_idx++;
    /* Top right part of the piece */
    gfx_sprite_set_x(&s_gfx, s_sprite_idx, iso_x + 16);
    gfx_sprite_set_y(&s_gfx, s_sprite_idx, iso_y);
    gfx_sprite_set_tile(&s_gfx, s_sprite_idx, start_tile + 1);
    gfx_sprite_set_flags(&s_gfx, s_sprite_idx, PIECES_PALETTE << 4);
    s_sprite_idx++;
    /* Bottom left part of the piece */
    gfx_sprite_set_x(&s_gfx, s_sprite_idx, iso_x);
    gfx_sprite_set_y(&s_gfx, s_sprite_idx, iso_y + 16);
    gfx_sprite_set_tile(&s_gfx, s_sprite_idx, start_tile + 2);
    gfx_sprite_set_flags(&s_gfx, s_sprite_idx, PIECES_PALETTE << 4);
    s_sprite_idx++;
    /* Bottom right part of the piece */
    gfx_sprite_set_x(&s_gfx, s_sprite_idx, iso_x + 16);
    gfx_sprite_set_y(&s_gfx, s_sprite_idx, iso_y + 16);
    gfx_sprite_set_tile(&s_gfx, s_sprite_idx, start_tile + 3);
    gfx_sprite_set_flags(&s_gfx, s_sprite_idx, PIECES_PALETTE << 4);
    s_sprite_idx++;
}
