#include <stdint.h>
#include <zos_sys.h>
#include <zos_vfs.h>
#include <zvb_gfx.h>
#include <zgdk/tilemap.h>

#include "assets.h"

/* 4 16-bit colors for the board palette */
const uint16_t s_board_palette[] = {
    /* 4 colors for the board */
    [0] = 0x4228,
    [1] = 0x4984,
    [2] = 0x7ae8,
    [3] = 0xde32,
#if MODERN_PALETTE
    /* Black palette */
    [16] = 0x0000,
    [17] = 0x31e7,
    [18] = 0x2104,
    [19] = 0x9452,
    [20] = 0x732e,
    [21] = 0x39a8,

    /* White palette */
    [32] = 0x0000,
    [33] = 0x31e7,
    [34] = 0x5aaa,
    [35] = 0xffff,
    [36] = 0x9492,
    [37] = 0xdefd,
#else
    /* Brown palette */
    [16] = 0x0000,  // unused
    [17] = 0x632c,  // Deep brown
    [18] = 0x842f,  // Dark wood
    [19] = 0xd5b4,  // Mid brown
    [20] = 0xcd72,
    [21] = 0xfed6,  // Highlight

    /* Beige palette */
    [32] = 0x0000,  // unused
    [33] = 0xB52D,
    [34] = 0xD675,
    [35] = 0xF718,
    [36] = 0xFF55,
    [37] = 0xFFF6,
#endif

    /* Highlighted palette */
    [48] = 0x0000,  // unused
    [49] = 0xf230,
    [50] = 0xee00,
    [51] = 0xed10,
    [52] = 0xf113,
    [53] = 0xf332,

};

const uint8_t s_board_tilemap[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x03, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x05, 0x06, 0x05, 0x06, 0x03, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x03, 0x04, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x02, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x03, 0x04, 0x00, 0x00,
    0x00, 0x00, 0x07, 0x08, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x09, 0x0a, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x07, 0x08, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x05, 0x06, 0x09, 0x0a, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x08, 0x05, 0x06, 0x05, 0x06, 0x09, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x08, 0x09, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

const uint8_t s_board_tileset[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x5f, 0x00, 0x00, 0x05, 0xff,
    0x00, 0x00, 0x5f, 0xff, 0x00, 0x05, 0xff, 0xff, 0x00, 0x5f, 0xff, 0xff,
    0x05, 0xff, 0xff, 0xff, 0x5f, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x05,
    0x00, 0x00, 0x00, 0x5a, 0x00, 0x00, 0x05, 0xaa, 0x00, 0x00, 0x5a, 0xaa,
    0x00, 0x05, 0xaa, 0xaa, 0x00, 0x5a, 0xaa, 0xaa, 0x05, 0xaa, 0xaa, 0xaa,
    0x5a, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0x5a, 0xaa, 0xaa, 0xaa,
    0xf5, 0xaa, 0xaa, 0xaa, 0xff, 0x5a, 0xaa, 0xaa, 0xff, 0xf5, 0xaa, 0xaa,
    0xff, 0xff, 0x5a, 0xaa, 0xff, 0xff, 0xf5, 0xaa, 0xff, 0xff, 0xff, 0x5a,
    0x50, 0x00, 0x00, 0x00, 0xa5, 0x00, 0x00, 0x00, 0xaa, 0x50, 0x00, 0x00,
    0xaa, 0xa5, 0x00, 0x00, 0xaa, 0xaa, 0x50, 0x00, 0xaa, 0xaa, 0xa5, 0x00,
    0xaa, 0xaa, 0xaa, 0x50, 0xaa, 0xaa, 0xaa, 0xa5, 0xaa, 0xaa, 0xaa, 0xa9,
    0xaa, 0xaa, 0xaa, 0x97, 0xaa, 0xaa, 0xa9, 0x7f, 0xaa, 0xaa, 0x97, 0xff,
    0xaa, 0xa9, 0x7f, 0xff, 0xaa, 0x97, 0xff, 0xff, 0xa9, 0x7f, 0xff, 0xff,
    0x97, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x50, 0x00, 0x00, 0x00, 0xf5, 0x00, 0x00, 0x00, 0xff, 0x50, 0x00, 0x00,
    0xff, 0xf5, 0x00, 0x00, 0xff, 0xff, 0x50, 0x00, 0xff, 0xff, 0xf5, 0x00,
    0xff, 0xff, 0xff, 0x50, 0xff, 0xff, 0xff, 0xf5, 0x5f, 0xff, 0xff, 0xff,
    0x97, 0xff, 0xff, 0xff, 0xa9, 0x7f, 0xff, 0xff, 0xaa, 0x97, 0xff, 0xff,
    0xaa, 0xa9, 0x7f, 0xff, 0xaa, 0xaa, 0x97, 0xff, 0xaa, 0xaa, 0xa9, 0x7f,
    0xaa, 0xaa, 0xaa, 0x97, 0xaa, 0xaa, 0xaa, 0xa9, 0xaa, 0xaa, 0xaa, 0xa5,
    0xaa, 0xaa, 0xaa, 0x5f, 0xaa, 0xaa, 0xa5, 0xff, 0xaa, 0xaa, 0x5f, 0xff,
    0xaa, 0xa5, 0xff, 0xff, 0xaa, 0x5f, 0xff, 0xff, 0xa5, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf5, 0xff, 0xff, 0xff, 0x5a,
    0xff, 0xff, 0xf5, 0xaa, 0xff, 0xff, 0x5a, 0xaa, 0xff, 0xf5, 0xaa, 0xaa,
    0xff, 0x5a, 0xaa, 0xaa, 0xf5, 0xaa, 0xaa, 0xaa, 0x5a, 0xaa, 0xaa, 0xaa,
    0xf5, 0xaa, 0xaa, 0xaa, 0xff, 0x5a, 0xaa, 0xaa, 0xff, 0xf5, 0xaa, 0xaa,
    0xff, 0xff, 0x5a, 0xaa, 0xff, 0xff, 0xf5, 0xaa, 0xff, 0xff, 0xff, 0x5a,
    0xff, 0xff, 0xff, 0xf5, 0x5f, 0xff, 0xff, 0xff, 0x05, 0xff, 0xff, 0xff,
    0x00, 0x5f, 0xff, 0xff, 0x00, 0x05, 0xff, 0xff, 0x00, 0x00, 0x5f, 0xff,
    0x00, 0x00, 0x05, 0xff, 0x00, 0x00, 0x00, 0x5f, 0x00, 0x00, 0x00, 0x05,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xf5,
    0xff, 0xff, 0xff, 0xd6, 0xff, 0xff, 0xfd, 0x6a, 0xff, 0xff, 0xd6, 0xaa,
    0xff, 0xfd, 0x6a, 0xaa, 0xff, 0xd6, 0xaa, 0xaa, 0xfd, 0x6a, 0xaa, 0xaa,
    0xd6, 0xaa, 0xaa, 0xaa, 0x5a, 0xaa, 0xaa, 0xaa, 0x05, 0xaa, 0xaa, 0xaa,
    0x00, 0x5a, 0xaa, 0xaa, 0x00, 0x05, 0xaa, 0xaa, 0x00, 0x00, 0x5a, 0xaa,
    0x00, 0x00, 0x05, 0xaa, 0x00, 0x00, 0x00, 0x5a, 0x00, 0x00, 0x00, 0x05,
    0xff, 0xff, 0xff, 0xff, 0x5f, 0xff, 0xff, 0xff, 0xa5, 0xff, 0xff, 0xff,
    0xaa, 0x5f, 0xff, 0xff, 0xaa, 0xa5, 0xff, 0xff, 0xaa, 0xaa, 0x5f, 0xff,
    0xaa, 0xaa, 0xa5, 0xff, 0xaa, 0xaa, 0xaa, 0x5f, 0xaa, 0xaa, 0xaa, 0xa5,
    0xaa, 0xaa, 0xaa, 0x50, 0xaa, 0xaa, 0xa5, 0x00, 0xaa, 0xaa, 0x50, 0x00,
    0xaa, 0xa5, 0x00, 0x00, 0xaa, 0x50, 0x00, 0x00, 0xa5, 0x00, 0x00, 0x00,
    0x50, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xf5, 0xff, 0xff, 0xff, 0x50,
    0xff, 0xff, 0xf5, 0x00, 0xff, 0xff, 0x50, 0x00, 0xff, 0xf5, 0x00, 0x00,
    0xff, 0x50, 0x00, 0x00, 0xf5, 0x00, 0x00, 0x00, 0x50, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

void _pieces_tileset(void) {
    __asm__(
        "__pieces_tileset_start:\n"
        "   .incbin \"assets/pieces_blue.zts\"\n"
        "__pieces_tileset_end:\n"
    );
}

zos_err_t load_palette(gfx_context* ctx) {
    gfx_error err;
    err = gfx_palette_load(ctx, (uint8_t*) s_board_palette, sizeof(s_board_palette), 0);
    return err;
}

zos_err_t load_board_tileset(gfx_context* ctx) {
    gfx_error err;
    /* The tileset is "compressed" in 2-bit mode, so 2 bits represent a pixel */
    gfx_tileset_options options = {
        .compression = TILESET_COMP_2BIT,
    };
    err = gfx_tileset_load(ctx, s_board_tileset, sizeof(s_board_tileset), &options);
    return err;
}

zos_err_t load_pieces_tileset(gfx_context* ctx) {
    gfx_error err;
    gfx_tileset_options options = {
        .compression = TILESET_COMP_NONE,
        // Start at tile 16 (16 * 128);
        .from_byte = TILE_PIECES_START << 7
    };
    const int pieces_tileset_size = &_pieces_tileset_end - &_pieces_tileset_start;
    err = gfx_tileset_load(ctx, &_pieces_tileset_start, pieces_tileset_size, &options);
    return err;
}


/** Splash Screen */
zos_err_t load_splash(gfx_context* ctx) {
    gfx_error err;
    uint16_t size;
    uint8_t buffer[1024];

    // Load the palette
    zos_dev_t ztp = open("splash.ztp", O_RDONLY);
    if(ztp < 0) return -ztp;

    size = 512; // 256 color
    err = read(ztp, buffer, &size);
    if(err) return err;

    err = gfx_palette_load(ctx, buffer, size, 0);
    if(err) return err;

    // Load the tileset
    zos_dev_t zts = open("splash.zts", O_RDONLY);
    if(zts < 0) -zts;

    gfx_tileset_options options = {
        .compression = TILESET_COMP_NONE,
        .from_byte = 0,
    };
    do {
        size = 1024;
        err = read(zts, buffer, &size);
        if(err != ERR_SUCCESS) {
            exit(0xFF);
        }
        if(size > 0) {
            err = gfx_tileset_load(ctx, buffer, size, &options);
            if(err != ERR_SUCCESS) {
                exit(0xFB);
            }
            options.from_byte += size;
        }
    } while(size > 0);

    return GFX_SUCCESS;
}

zos_err_t load_splash_tilemap(gfx_context* ctx) {
    gfx_error err;
    uint16_t size;
    uint8_t buffer[1024];

    zos_dev_t ztm = open("splash.ztm", O_RDONLY);
    if(ztm < 0) return -ztm;

    size = (WIDTH * HEIGHT);
    err = read(ztm, buffer, &size);
    if(err) return err;

    if(size > 0) {
        uint8_t *tilemap = buffer;
        for(uint8_t y = 0; y < HEIGHT; y++) {
            err = gfx_tilemap_load(ctx, tilemap, WIDTH, LAYER0, 0, y);
            if(err) return err;
            tilemap += WIDTH;
        }
    }

    err = gfx_tileset_add_color_tile(ctx, EMPTY_TILE, 0);
    return err;
}